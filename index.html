<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Health CV Demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Modern professional font -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont,
          "Segoe UI", sans-serif;
        color: #020617;
        background-color: #e5e7eb;
      }

      body {
        margin: 0;
        padding: 32px 24px;
        display: flex;
        justify-content: center;
      }

      .page {
        max-width: 1120px;
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      .hero {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 4px;
      }

      .hero-title {
        font-size: 26px;
        font-weight: 650;
        letter-spacing: -0.02em;
      }

      .hero-sub {
        font-size: 14px;
        color: #6b7280;
        max-width: 540px;
      }

      .steps {
        display: flex;
        gap: 10px;
        font-size: 12px;
        color: #6b7280;
        margin-top: 4px;
        flex-wrap: wrap;
      }

      .step-pill {
        padding: 4px 10px;
        border-radius: 999px;
        background: #f9fafb;
        border: 1px solid #e5e7eb;
      }

      .cards {
        display: grid;
        grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.9fr);
        gap: 20px;
      }

      @media (max-width: 900px) {
        body {
          padding: 20px 16px;
        }
        .cards {
          grid-template-columns: minmax(0, 1fr);
        }
      }

      @media (max-width: 600px) {
        body {
          padding: 16px 12px;
        }
        .hero-title {
          font-size: 22px;
        }
      }

      .card {
        background: #f9fafb;
        border-radius: 22px;
        padding: 24px 24px;
        box-shadow: 0 18px 40px rgba(15, 23, 42, 0.06);
        border: 1px solid #e5e7eb;
      }

      h2 {
        margin: 0 0 4px;
        font-size: 17px;
      }

      .sub {
        font-size: 12px;
        color: #6b7280;
        margin-bottom: 18px;
      }

      label {
        font-size: 13px;
        font-weight: 600;
        color: #374151;
        display: block;
        margin-bottom: 4px;
      }

      input[type="text"],
      textarea {
        width: 100%;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        padding: 8px 10px;
        font-size: 13px;
        resize: vertical;
        min-height: 36px;
        background: #ffffff;
      }

      textarea {
        min-height: 60px;
      }

      .field {
        margin-bottom: 18px;
      }

      .field-row {
        display: flex;
        gap: 16px;
      }

      .field-row .field {
        flex: 1;
      }

      @media (max-width: 700px) {
        .field-row {
          flex-direction: column;
        }
      }

      .hint {
        font-size: 11px;
        color: #9ca3af;
        margin-top: 3px;
      }

      .button {
        margin-top: 12px;
        padding: 9px 18px;
        border-radius: 999px;
        border: none;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        background: #0f172a;
        color: #f9fafb;
        box-shadow: 0 10px 25px rgba(15, 23, 42, 0.25);
      }

      .button.secondary {
        background: #e5e7eb;
        color: #111827;
        box-shadow: none;
        margin-top: 16px;
      }

      .cv-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 12px;
        flex-wrap: wrap;
      }

      .cv-header-main {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .cv-name {
        font-size: 18px;
        font-weight: 600;
      }

      .cv-meta {
        font-size: 11px;
        color: #6b7280;
      }

      .cv-section-title {
        font-size: 13px;
        font-weight: 600;
        margin-top: 14px;
        margin-bottom: 6px;
      }

      .chip {
        display: inline-flex;
        padding: 3px 10px;
        border-radius: 999px;
        background: #e0f2fe;
        font-size: 11px;
        color: #0369a1;
        border: 1px solid #bae6fd;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid #e5e7eb;
        font-size: 12px;
        cursor: pointer;
        background: #ffffff;
        margin: 3px 5px 5px 0;
        transition: 0.12s;
      }

      .pill span.term {
        text-decoration: underline;
        text-decoration-style: dotted;
        text-underline-offset: 2px;
      }

      .pill:hover {
        background: #eff6ff;
        box-shadow: 0 6px 14px rgba(37, 99, 235, 0.12);
        transform: translateY(-1px);
      }

      .cv-row {
        font-size: 13px;
        margin-bottom: 5px;
      }

      .quote-box {
        font-size: 13px;
        background: #ffffff;
        border-radius: 14px;
        padding: 10px 12px;
        margin-top: 6px;
        border: 1px dashed #e5e7eb;
      }

      .files-list {
        font-size: 12px;
        color: #4b5563;
      }

      .file-pill {
        display: inline-flex;
        padding: 3px 8px;
        border-radius: 999px;
        background: #f3f4f6;
        border: 1px solid #e5e7eb;
        margin: 3px 6px 3px 0;
      }

      .file-input {
        width: 100%;
        font-size: 12px;
      }

      .edu-panel {
        position: fixed;
        right: 24px;
        bottom: 24px;
        max-width: 320px;
        background: #ffffff;
        border-radius: 18px;
        box-shadow: 0 22px 55px rgba(15, 23, 42, 0.28);
        padding: 16px 18px 14px;
        display: none;
        border: 1px solid #e5e7eb;
      }

      .edu-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 6px;
      }

      .edu-chip {
        font-size: 11px;
        padding: 2px 8px;
        border-radius: 999px;
        background: #eff6ff;
        color: #1d4ed8;
      }

      .edu-title {
        font-size: 13px;
        font-weight: 600;
        margin-bottom: 4px;
      }

      .edu-body {
        font-size: 13px;
        color: #4b5563;
        margin-bottom: 10px;
      }

      .edu-close {
        border: none;
        background: none;
        color: #6b7280;
        font-size: 12px;
        cursor: pointer;
      }

      .edu-term-label {
        font-size: 11px;
        color: #9ca3af;
        margin-bottom: 4px;
      }

      /* Specialty toggle & dimming */
      .specialty-toggle {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 4px;
      }

      .specialty-button {
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid #d1d5db;
        background: #f3f4f6;
        font-size: 11px;
        cursor: pointer;
      }

      .specialty-button.active {
        background: #111827;
        color: #f9fafb;
        border-color: #111827;
      }

      .cv-section.dimmed {
        opacity: 0.5;
      }
    </style>
  </head>

  <body>
    <div class="page">
      <!-- HERO -->
      <div class="hero">
        <div class="hero-title">Health CV (Demo)</div>
        <div class="hero-sub">
          A simple way for patients to capture their story once and share it
          anywhere. Fill in your details, then see the 1-page CV a doctor would
          read.
        </div>

        <div class="steps">
          <div class="step-pill">Step 1 · Enter your information</div>
          <div class="step-pill">Step 2 · Review your Health CV</div>
          <div class="step-pill">
            Step 3 · Click items for plain-language info
          </div>
        </div>
      </div>

      <!-- MAIN CARDS -->
      <div class="cards">
        <!-- LEFT: INTAKE -->
        <div class="card" id="intakeCard">
          <h2>Step 1 · Tell us about your health</h2>
          <div class="sub">
            You can use a real example or a made-up one. No data is saved in
            this demo.
          </div>

          <div class="field-row">
            <div class="field">
              <label>Full name (optional)</label>
              <input type="text" id="nameInput" placeholder="Sam Smith" />
            </div>
            <div class="field">
              <label>Date of birth</label>
              <input
                type="text"
                id="dobInput"
                placeholder="e.g. 01/15/1980"
              />
              <div class="hint">Use any standard date format.</div>
            </div>
          </div>

          <!-- What’s important to me (still here in intake, but will appear at top of CV) -->
          <div class="field">
            <label>What’s important to me</label>
            <textarea
              id="importantInput"
              placeholder="I want to stay active for my family, understand my options clearly, and avoid unnecessary hospitalizations."
            ></textarea>
            <div class="hint">
              The one line you want every doctor to read first.
            </div>
          </div>

          <!-- Vitals -->
          <div class="field-row">
            <div class="field">
              <label>Blood pressure readings</label>
              <textarea
                id="bpInput"
                placeholder="One per line, e.g.&#10;122/76&#10;128/82&#10;118/74"
              ></textarea>
              <div class="hint">
                Multiple readings are best. We’ll calculate an average.
              </div>
            </div>

            <div class="field">
              <label>Heart rate (beats per minute)</label>
              <input type="text" id="hrInput" placeholder="e.g. 72" />
              <div class="hint">Your usual resting heart rate.</div>
            </div>
          </div>

          <div class="field-row">
            <div class="field">
              <label>Weight</label>
              <input
                type="text"
                id="weightInput"
                placeholder="e.g. 80 kg or 175 lb"
              />
            </div>

            <div class="field">
              <label>Height</label>
              <input
                type="text"
                id="heightInput"
                placeholder="e.g. 170 cm or 5'7&quot;"
              />
            </div>
          </div>

          <!-- Problems & Past Surgical Hx -->
          <div class="field">
            <label>Problem list</label>
            <textarea
              id="problemsInput"
              placeholder="One per line, e.g.&#10;Hypertension&#10;Type 2 diabetes&#10;Generalized anxiety&#10;Hyperlipidemia"
            ></textarea>
            <div class="hint">Your ongoing medical conditions.</div>
          </div>

          <div class="field">
            <label>Past surgical history</label>
            <textarea
              id="surgeryInput"
              placeholder="One per line, e.g.&#10;Appendectomy (2010)&#10;Cesarean section (2018)&#10;Arthroscopic knee surgery (2021)"
            ></textarea>
          </div>

          <div class="field">
            <label>Current medications (with dose &amp; frequency)</label>
            <textarea
              id="currentMedsInput"
              placeholder="One per line, e.g.&#10;Metformin 500 mg twice daily&#10;Atorvastatin 20 mg at night&#10;Sertraline 50 mg each morning"
            ></textarea>
          </div>

          <div class="field">
            <label>Medications you tried in the past and why you stopped</label>
            <textarea
              id="pastMedsInput"
              placeholder="One per line, e.g.&#10;Lisinopril – cough&#10;Sertraline – weight gain&#10;Naproxen – stomach upset"
            ></textarea>
          </div>

          <div class="field">
            <label>Allergies</label>
            <textarea
              id="allergiesInput"
              placeholder="e.g. Penicillin – rash&#10;Shellfish – hives&#10;No known drug allergies"
            ></textarea>
          </div>

          <div class="field-row">
            <div class="field">
              <label>Important lab results</label>
              <textarea
                id="labsInput"
                placeholder="One per line, e.g.&#10;A1c 6.7% (2025)&#10;LDL 115, HDL 50, Total 200&#10;Creatinine 0.9, eGFR &gt; 90"
              ></textarea>
            </div>

            <div class="field">
              <label>Imaging or procedures</label>
              <textarea
                id="imagingInput"
                placeholder="One per line, e.g.&#10;CT chest (2022) – no pulmonary embolism&#10;MRI knee (2021) – medial meniscus tear&#10;Screening colonoscopy (2024) – normal"
              ></textarea>
            </div>
          </div>

          <div class="field">
            <label>Social history (optional)</label>
            <textarea
              id="socialInput"
              placeholder="Lives with partner and 2 kids, works in an office, walks for exercise 3x/week. Never smoked, drinks 1–2 glasses of wine/week."
            ></textarea>
          </div>

          <div class="field">
            <label>Attach files (optional)</label>
            <input
              type="file"
              id="fileInput"
              class="file-input"
              multiple
              accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.txt"
            />
            <div class="hint">
              In a real product, this could include discharge summaries, imaging
              reports, or lab PDFs. In this demo, we can try to auto-fill from a
              simple text-based report.
            </div>
            <button
              type="button"
              class="button secondary"
              id="autoPopulateBtn"
            >
              Auto-fill from first attached record (demo)
            </button>
          </div>

          <button class="button" id="generateBtn" type="button">
            Create my Health CV
          </button>
        </div>

        <!-- RIGHT: CV VIEW -->
        <div class="card" id="cvCard" style="display: none">
          <div class="cv-header">
            <div class="cv-header-main">
              <div class="cv-name" id="cvName">Health CV</div>
              <div class="cv-meta" id="cvDob"></div>
              <div class="cv-meta">
                Preview of what a clinician would see, based on your inputs.
              </div>
            </div>
            <div class="chip">Click items for explanations</div>
          </div>

          <!-- What’s important to me now near the top -->
          <div class="cv-section" data-section="important">
            <div class="cv-section-title">What’s important to me</div>
            <div class="quote-box" id="cvImportant"></div>
          </div>

          <div class="cv-section" data-section="vitals">
            <div class="cv-section-title">Baseline vitals</div>
            <div class="cv-row" id="cvVitalsBp"></div>
            <div class="cv-row" id="cvVitalsHr"></div>
            <div class="cv-row" id="cvVitalsWt"></div>
            <div class="cv-row" id="cvVitalsHt"></div>
          </div>

          <div class="cv-section" data-section="problems">
            <div class="cv-section-title">Active problems</div>
            <div id="cvProblems"></div>
          </div>

          <div class="cv-section" data-section="surgery">
            <div class="cv-section-title">Past surgical history</div>
            <div id="cvSurgery"></div>
          </div>

          <div class="cv-section" data-section="currentMeds">
            <div class="cv-section-title">Current medications</div>
            <div id="cvCurrentMeds"></div>
          </div>

          <div class="cv-section" data-section="pastMeds">
            <div class="cv-section-title">
              Medications tried in the past (and why stopped)
            </div>
            <div id="cvPastMeds"></div>
          </div>

          <div class="cv-section" data-section="allergies">
            <div class="cv-section-title">Allergies</div>
            <div id="cvAllergies"></div>
          </div>

          <div class="cv-section" data-section="labs">
            <div class="cv-section-title">Key labs</div>
            <div id="cvLabs"></div>
          </div>

          <div class="cv-section" data-section="imaging">
            <div class="cv-section-title">Imaging &amp; procedures</div>
            <div id="cvImaging"></div>
          </div>

          <div class="cv-section" data-section="social">
            <div class="cv-section-title">Social history</div>
            <div class="cv-row" id="cvSocial"></div>
          </div>

          <div class="cv-section" data-section="files">
            <div class="cv-section-title">Files attached (demo only)</div>
            <div class="files-list" id="cvFiles"></div>
          </div>

          <!-- Specialty view toggle -->
          <div class="cv-section" data-section="specialty">
            <div class="cv-section-title">
              Adjust view for different clinicians
            </div>
            <div class="specialty-toggle">
              <button
                type="button"
                class="specialty-button active"
                data-specialty="primary"
              >
                Primary care / adult
              </button>
              <button
                type="button"
                class="specialty-button"
                data-specialty="cardiology"
              >
                Cardiology
              </button>
              <button
                type="button"
                class="specialty-button"
                data-specialty="psychiatry"
              >
                Psychiatry
              </button>
              <button
                type="button"
                class="specialty-button"
                data-specialty="pediatrics"
              >
                Pediatrics
              </button>
            </div>
            <div class="hint">
              This doesn’t change your data — just which sections are emphasized
              for the type of visit.
            </div>
          </div>

          <button class="button secondary" id="editBtn" type="button">
            Back to edit my information
          </button>
        </div>
      </div>
    </div>

    <!-- EDUCATION PANEL -->
    <div class="edu-panel" id="eduPanel">
      <div class="edu-header">
        <div class="edu-chip">Health CV Assistant</div>
        <button class="edu-close" id="eduClose">Close</button>
      </div>
      <div class="edu-term-label" id="eduTermLabel"></div>
      <div class="edu-title" id="eduTitle"></div>
      <div class="edu-body" id="eduBody"></div>
    </div>

    <script>
      // Glossary for some common terms (simulated AI)
      const glossary = {
        hypertension: {
          title: "Hypertension (High Blood Pressure)",
          body:
            "High blood pressure means the force of blood pushing against your artery walls is consistently too high. Over time this can strain the heart, brain, and kidneys and raise the risk of heart attack and stroke.",
        },
        "type 2 diabetes": {
          title: "Type 2 Diabetes",
          body:
            "Type 2 diabetes is a condition where your body has trouble using insulin well. Sugar builds up in the blood instead of going into cells for energy. Over many years, this can affect the eyes, kidneys, nerves, and heart.",
        },
        metformin: {
          title: "Metformin",
          body:
            "Metformin is a medication that helps lower blood sugar. It mainly works by helping your body use insulin better and by lowering how much sugar your liver releases into the blood.",
        },
        olmesartan: {
          title: "Olmesartan",
          body:
            "Olmesartan is a blood pressure medication called an ARB. It helps relax blood vessels, making it easier for the heart to pump and lowering the risk of heart and kidney problems.",
        },
        lisinopril: {
          title: "Lisinopril",
          body:
            "Lisinopril is a blood pressure medication called an ACE inhibitor. A common side effect is a dry cough, which is one reason some people are switched to a different medicine.",
        },
        wellbutrin: {
          title: "Wellbutrin (Bupropion)",
          body:
            "Wellbutrin, also called bupropion, is often used for depression or to help people stop smoking. It can cause side effects like trouble sleeping, nausea, or feeling more anxious in some people.",
        },
        a1c: {
          title: "Hemoglobin A1c",
          body:
            "A1c is a blood test that shows your average blood sugar level over the past 2–3 months. Many people with diabetes aim for an A1c around 7%, but the right goal depends on the person and should be set with their doctor.",
        },
        ct: {
          title: "CT Scan",
          body:
            "A CT scan uses X-rays and a computer to make detailed pictures of the inside of the body. It helps doctors look at organs, blood vessels, and bones.",
        },
        mri: {
          title: "MRI",
          body:
            "MRI uses strong magnets and radio waves to create detailed pictures of the inside of the body. It is especially useful for the brain, spine, joints, and other soft tissues.",
        },
        penicillin: {
          title: "Penicillin Allergy",
          body:
            "A penicillin allergy means your body reacts to penicillin antibiotics. Reactions can range from rash to more serious symptoms. It is important to tell every doctor and pharmacist about this.",
        },
      };

      // Helpers
      function lines(value) {
        return value
          .split("\n")
          .map((l) => l.trim())
          .filter(Boolean);
      }

      function normalizeKey(text) {
        const t = text.toLowerCase();
        if (t.includes("hypertension")) return "hypertension";
        if (t.includes("type 2")) return "type 2 diabetes";
        if (t.includes("metformin")) return "metformin";
        if (t.includes("olmesartan")) return "olmesartan";
        if (t.includes("lisinopril")) return "lisinopril";
        if (t.includes("wellbutrin") || t.includes("bupropion"))
          return "wellbutrin";
        if (t.includes("a1c")) return "a1c";
        if (t.includes(" ct ")) return "ct";
        if (t.startsWith("ct ")) return "ct";
        if (t.includes("mri")) return "mri";
        if (t.includes("penicillin")) return "penicillin";
        return null;
      }

      function computeBpAverage(value) {
        const arr = lines(value);
        let systolicSum = 0;
        let diastolicSum = 0;
        let count = 0;
        const regex = /(\d+)\s*\/\s*(\d+)/;
        arr.forEach((line) => {
          const match = line.match(regex);
          if (match) {
            systolicSum += parseInt(match[1], 10);
            diastolicSum += parseInt(match[2], 10);
            count += 1;
          }
        });
        if (!count) return null;
        return {
          systolic: Math.round(systolicSum / count),
          diastolic: Math.round(diastolicSum / count),
          count,
        };
      }

      // Education panel
      const eduPanel = document.getElementById("eduPanel");
      const eduTitle = document.getElementById("eduTitle");
      const eduBody = document.getElementById("eduBody");
      const eduTermLabel = document.getElementById("eduTermLabel");
      const eduClose = document.getElementById("eduClose");

      function showTerm(key, originalText) {
        const info = glossary[key];
        if (!info) return showGeneric(originalText);
        eduTermLabel.textContent = `You clicked: “${originalText.trim()}”`;
        eduTitle.textContent = info.title;
        eduBody.textContent = info.body;
        eduPanel.style.display = "block";
      }

      function showGeneric(text) {
        eduTermLabel.textContent = `You clicked: “${text}”`;
        eduTitle.textContent = "Let’s make this easier to talk about";
        eduBody.textContent =
          "This might be a diagnosis, medication, test, or procedure that matters to you. In the full Health CV product, an AI assistant would pull a clear, plain-language explanation here. For now, you can use this as a reminder to ask: What is it? Why do I have it? How is it monitored or treated? What should I watch for?";
        eduPanel.style.display = "block";
      }

      eduClose.addEventListener("click", () => {
        eduPanel.style.display = "none";
      });

      function makePill(text) {
        const pill = document.createElement("button");
        pill.type = "button";
        pill.className = "pill";
        const span = document.createElement("span");
        span.className = "term";
        span.textContent = text.trim();
        pill.appendChild(span);

        const key = normalizeKey(text);
        pill.addEventListener("click", () => {
          if (key && glossary[key]) showTerm(key, text);
          else showGeneric(text.trim() || "This item");
        });

        return pill;
      }

      // DOM elements
      const intakeCard = document.getElementById("intakeCard");
      const cvCard = document.getElementById("cvCard");

      const nameInput = document.getElementById("nameInput");
      const dobInput = document.getElementById("dobInput");
      const bpInput = document.getElementById("bpInput");
      const hrInput = document.getElementById("hrInput");
      const weightInput = document.getElementById("weightInput");
      const heightInput = document.getElementById("heightInput");
      const problemsInput = document.getElementById("problemsInput");
      const surgeryInput = document.getElementById("surgeryInput");
      const currentMedsInput = document.getElementById("currentMedsInput");
      const pastMedsInput = document.getElementById("pastMedsInput");
      const allergiesInput = document.getElementById("allergiesInput");
      const labsInput = document.getElementById("labsInput");
      const imagingInput = document.getElementById("imagingInput");
      const socialInput = document.getElementById("socialInput");
      const importantInput = document.getElementById("importantInput");
      const fileInput = document.getElementById("fileInput");

      const cvName = document.getElementById("cvName");
      const cvDob = document.getElementById("cvDob");
      const cvVitalsBp = document.getElementById("cvVitalsBp");
      const cvVitalsHr = document.getElementById("cvVitalsHr");
      const cvVitalsWt = document.getElementById("cvVitalsWt");
      const cvVitalsHt = document.getElementById("cvVitalsHt");
      const cvProblems = document.getElementById("cvProblems");
      const cvSurgery = document.getElementById("cvSurgery");
      const cvCurrentMeds = document.getElementById("cvCurrentMeds");
      const cvPastMeds = document.getElementById("cvPastMeds");
      const cvAllergies = document.getElementById("cvAllergies");
      const cvLabs = document.getElementById("cvLabs");
      const cvImaging = document.getElementById("cvImaging");
      const cvSocial = document.getElementById("cvSocial");
      const cvImportant = document.getElementById("cvImportant");
      const cvFiles = document.getElementById("cvFiles");

      const generateBtn = document.getElementById("generateBtn");
      const editBtn = document.getElementById("editBtn");
      const autoPopulateBtn = document.getElementById("autoPopulateBtn");
      const specialtyButtons = document.querySelectorAll(".specialty-button");

      // Specialty configuration: which sections get dimmed for each view
      const specialtyConfig = {
        primary: {
          dim: [], // show everything equally
        },
        cardiology: {
          dim: ["social", "files"],
        },
        psychiatry: {
          dim: ["labs", "imaging", "files"],
        },
        pediatrics: {
          dim: ["pastMeds", "surgery", "files"],
        },
      };

      function setSpecialtyView(specialty) {
        specialtyButtons.forEach((btn) => {
          btn.classList.toggle(
            "active",
            btn.dataset.specialty === specialty
          );
        });

        const allSections = document.querySelectorAll(".cv-section");
        const cfg = specialtyConfig[specialty] || { dim: [] };

        allSections.forEach((section) => {
          const key = section.getAttribute("data-section");
          // Never dim the "what's important to me" or the specialty controls themselves
          if (!key || key === "important" || key === "specialty") {
            section.classList.remove("dimmed");
            return;
          }
          if (cfg.dim && cfg.dim.includes(key)) {
            section.classList.add("dimmed");
          } else {
            section.classList.remove("dimmed");
          }
        });
      }

      specialtyButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const spec = btn.dataset.specialty || "primary";
          setSpecialtyView(spec);
        });
      });

      // Auto-populate from attached text-based record (demo)
      function autoPopulateFromText(text) {
        const lower = text.toLowerCase();

        // Problems detection
        const detectedProblems = [];
        function addProblem(p) {
          if (!detectedProblems.includes(p)) detectedProblems.push(p);
        }

        if (lower.includes("hypertension") || lower.includes("high blood pressure")) {
          addProblem("Hypertension (high blood pressure)");
        }
        if (lower.includes("type 2") || lower.includes("type ii diabetes") || lower.includes("t2dm")) {
          addProblem("Type 2 diabetes");
        }
        if (lower.includes("anxiety")) {
          addProblem("Anxiety");
        }
        if (lower.includes("depression")) {
          addProblem("Depression");
        }
        if (lower.includes("hyperlipid") || lower.includes("high cholesterol")) {
          addProblem("Hyperlipidemia / high cholesterol");
        }

        if (!problemsInput.value.trim() && detectedProblems.length) {
          problemsInput.value = detectedProblems.join("\n");
        }

        // Current medications detection
        const detectedMeds = [];
        function addMed(m) {
          if (!detectedMeds.includes(m)) detectedMeds.push(m);
        }

        if (lower.includes("metformin")) addMed("Metformin");
        if (lower.includes("sertraline") || lower.includes("zoloft"))
          addMed("Sertraline");
        if (lower.includes("atorvastatin") || lower.includes("lipitor"))
          addMed("Atorvastatin");
        if (lower.includes("lisinopril")) addMed("Lisinopril");
        if (lower.includes("olmesartan")) addMed("Olmesartan");

        if (!currentMedsInput.value.trim() && detectedMeds.length) {
          currentMedsInput.value = detectedMeds.join("\n");
        }

        // Allergies detection
        const detectedAllergies = [];
        if (lower.includes("penicillin")) {
          detectedAllergies.push("Penicillin – allergy (details to confirm)");
        }
        if (lower.includes("shellfish")) {
          detectedAllergies.push("Shellfish – allergy (details to confirm)");
        }
        if (!allergiesInput.value.trim() && detectedAllergies.length) {
          allergiesInput.value = detectedAllergies.join("\n");
        }

        const allLines = text.split(/\r?\n/);

        // Labs: grab lines that look like common lab references
        const labLines = [];
        allLines.forEach((line) => {
          const l = line.toLowerCase();
          if (
            l.includes("a1c") ||
            l.includes("hba1c") ||
            l.includes("ldl") ||
            l.includes("hdl") ||
            l.includes("cholesterol") ||
            l.includes("creatinine") ||
            l.includes("egfr")
          ) {
            labLines.push(line.trim());
          }
        });
        if (!labsInput.value.trim() && labLines.length) {
          labsInput.value = labLines.join("\n");
        }

        // Imaging: grab lines with CT/MRI/X-ray/ultrasound/etc.
        const imgLines = [];
        allLines.forEach((line) => {
          const l = line.toLowerCase();
          if (
            l.includes("ct ") ||
            l.startsWith("ct") ||
            l.includes("mri") ||
            l.includes("x-ray") ||
            l.includes("xray") ||
            l.includes("ultrasound") ||
            l.includes("echo") ||
            l.includes("echocardiogram") ||
            l.includes("colonoscopy")
          ) {
            imgLines.push(line.trim());
          }
        });
        if (!imagingInput.value.trim() && imgLines.length) {
          imagingInput.value = imgLines.join("\n");
        }

        // Blood pressure readings in text
        const bpMatches = text.match(/(\d{2,3})\s*\/\s*(\d{2,3})/g);
        if (!bpInput.value.trim() && bpMatches && bpMatches.length) {
          bpInput.value = bpMatches.join("\n");
        }

        // Heart rate
        const hrMatch = text.match(/(heart rate|hr)[^0-9]{0,10}(\d{2,3})/i);
        if (!hrInput.value.trim() && hrMatch) {
          hrInput.value = hrMatch[2];
        }

        // Very simple social history heuristic
        if (!socialInput.value.trim()) {
          const socialLine = allLines.find((line) =>
            line.toLowerCase().includes("lives with")
          );
          if (socialLine) {
            socialInput.value = socialLine.trim();
          }
        }

        alert(
          "We’ve done a best-effort demo import from the attached record. Please review and adjust the fields before generating your Health CV."
        );
      }

      autoPopulateBtn.addEventListener("click", () => {
        if (!fileInput.files || fileInput.files.length === 0) {
          alert("Please attach a text-based record file first (e.g., .txt).");
          return;
        }

        const file = fileInput.files[0];
        const reader = new FileReader();

        reader.onload = (e) => {
          const text = e.target.result || "";
          autoPopulateFromText(String(text));
        };

        reader.onerror = () => {
          alert("There was a problem reading that file in this demo.");
        };

        // For PDFs/Word docs this may not work well, but it's fine for demo text
        reader.readAsText(file);
      });

      // Generate CV
      generateBtn.addEventListener("click", () => {
        const name = nameInput.value.trim();
        const dob = dobInput.value.trim();
        cvName.textContent = name || "Health CV";
        cvDob.textContent = dob ? `Date of birth: ${dob}` : "";

        // Vitals
        const bpAvg = computeBpAverage(bpInput.value);
        if (bpAvg) {
          cvVitalsBp.textContent = `Blood pressure: ${bpAvg.systolic}/${bpAvg.diastolic} (average of ${bpAvg.count} readings)`;
        } else if (bpInput.value.trim()) {
          cvVitalsBp.textContent =
            "Blood pressure: readings entered, but could not calculate an average.";
        } else {
          cvVitalsBp.textContent = "Blood pressure: not entered.";
        }

        const hr = hrInput.value.trim();
        cvVitalsHr.textContent = hr ? `Heart rate: ${hr} bpm` : "";

        const wt = weightInput.value.trim();
        cvVitalsWt.textContent = wt ? `Weight: ${wt}` : "";

        const ht = heightInput.value.trim();
        cvVitalsHt.textContent = ht ? `Height: ${ht}` : "";

        // Problems
        cvProblems.innerHTML = "";
        const probs = lines(problemsInput.value);
        if (!probs.length) {
          cvProblems.textContent = "No problems entered yet.";
        } else {
          probs.forEach((p) => cvProblems.appendChild(makePill(p)));
        }

        // Past surgical history
        cvSurgery.innerHTML = "";
        const surg = lines(surgeryInput.value);
        if (!surg.length) {
          cvSurgery.textContent = "No prior surgeries listed.";
        } else {
          surg.forEach((s) => cvSurgery.appendChild(makePill(s)));
        }

        // Current meds
        cvCurrentMeds.innerHTML = "";
        const curr = lines(currentMedsInput.value);
        if (!curr.length) {
          cvCurrentMeds.textContent = "No current medications entered.";
        } else {
          curr.forEach((m) => cvCurrentMeds.appendChild(makePill(m)));
        }

        // Past meds
        cvPastMeds.innerHTML = "";
        const past = lines(pastMedsInput.value);
        if (!past.length) {
          cvPastMeds.textContent = "No prior medications listed.";
        } else {
          past.forEach((m) => cvPastMeds.appendChild(makePill(m)));
        }

        // Allergies
        cvAllergies.innerHTML = "";
        const alls = lines(allergiesInput.value);
        if (!alls.length) {
          cvAllergies.textContent = "No allergies recorded.";
        } else {
          alls.forEach((a) => cvAllergies.appendChild(makePill(a)));
        }

        // Labs
        cvLabs.innerHTML = "";
        const labs = lines(labsInput.value);
        if (!labs.length) {
          cvLabs.textContent = "No lab results entered.";
        } else {
          labs.forEach((l) => cvLabs.appendChild(makePill(l)));
        }

        // Imaging
        cvImaging.innerHTML = "";
        const imgs = lines(imagingInput.value);
        if (!imgs.length) {
          cvImaging.textContent = "No imaging or procedures entered.";
        } else {
          imgs.forEach((i) => cvImaging.appendChild(makePill(i)));
        }

        // Social
        const social = socialInput.value.trim();
        cvSocial.textContent =
          social ||
          "Use this space to describe your home life, work, daily activity, and habits like smoking or alcohol use.";

        // Important to me (now at top)
        const imp = importantInput.value.trim();
        cvImportant.textContent =
          imp ||
          "Use this space to tell your doctor what matters most to you, in your own words.";

        // Files
        cvFiles.innerHTML = "";
        if (fileInput.files && fileInput.files.length > 0) {
          Array.from(fileInput.files).forEach((f) => {
            const span = document.createElement("span");
            span.className = "file-pill";
            span.textContent = f.name;
            cvFiles.appendChild(span);
          });
        } else {
          cvFiles.textContent =
            "No files attached in this demo. In a full product, file names or icons would appear here.";
        }

        // Show CV & reset specialty view to primary
        cvCard.style.display = "block";
        setSpecialtyView("primary");
        cvCard.scrollIntoView({ behavior: "smooth" });
      });

      // Back to edit
      editBtn.addEventListener("click", () => {
        intakeCard.scrollIntoView({ behavior: "smooth" });
      });

      /*
        In a real AI-powered version, inside showTerm/showGeneric you would
        call your backend, e.g. POST /api/explain with { term, context }.
        The backend would talk to an AI model. You never put the API key
        in this browser code.
      */
    </script>
  </body>
</html>
